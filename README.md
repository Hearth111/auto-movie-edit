# 要件定義サマリー：YMM4直変換・台帳駆動のショート動画生成

## 0. 目的とゴール
- 入力：Vrewで生成したSRTと、台帳（スプレッドシート/Excel）。
- 出力：ゆっくりムービーメーカー4互換の`.ymmp`ファイルを自動生成し、最小限の手作業でショート動画を量産できる状態にする。
- 編集要素：テロップ、立ち絵、効果音、背景、ズーム・集中線・シェイクなどの演出。定義済みパターン（パック）として登録し、プルダウン選択で適用。

## 1. 用語と概念
| 用語 | 説明 |
| --- | --- |
| 台帳 | `TIMELINE`シート。1行=1カット。列の左→右が前面→背面（Z順）。|
| 単一オブジェクト | 画像・音声・動画・テキストなど素材1件。|
| パック（複数オブジェクト） | Group/Tachie/Item集合とエフェクト設定をまとめたテンプレ。|
| テロップパターン | テロップ専用パック。TextItem＋必要な装飾を保持。|
| 演出（FX） | ズーム、集中線、シェイク、ビネット、モーションブラーなど。単体またはパックで表現。|

## 2. 台帳スプレッドシート構成
### 2.1 シート一覧
- `TELP_PATTERNS`：テロップパターン定義
- `ASSETS_SINGLE`：単一オブジェクト辞書
- `PACKS_MULTI`：複数オブジェクト辞書
- `LAYERS`：役割とレイヤ帯の対応
- `TIMELINE`：動画生成の配置指示
- `SCHEMA_MAP`：シート列の日本語⇔内部キー対応（実行時参照）
- `EXPRESSION_PRESETS`：表情プリセットの定義（トーン連動にも使用）

### 2.2 主なカラム
**テロップパターン**
- パターンID（主キー）
- 参照ソース（例：`template://packs/telop_emphasis_yellow.json`）
- 上書きキー（`Text, Frame, Length, X, Y, Zoom, FilePath`など）
- 基準幅 / 基準高さ / FPS（メタ情報）
- 説明 / 備考

**単一オブジェクト**
- 素材ID（主キー）
- 種別（`image | audio | video | text | effect`）
- パス（相対/絶対、`template://...`も可）
- 既定レイヤ / 既定X / 既定Y / 既定ズーム
- 備考

**複数オブジェクト（パック）**
- パックID（主キー）
- 参照ソース（例：`template://packs/*.json`）
- 上書きキー（`Text, FilePath, Frame, Length, X, Y, Zoom`など）
- 基準幅 / 基準高さ / FPS
- 備考

**表情プリセット**
- プリセットID（主キー）
- トーン（`質問調` / `強調` / `余韻` など。カンマ区切りで複数指定可）
- キャラクター（特定キャラ専用にする場合のみ）
- 各パーツの差分ファイル名（例：目=`03_驚き`）
- 備考

**レイヤ割り当て**
- 役割→レイヤ帯（例：`テロップ=80`、`立ち絵=70`、`背景=10`）

**TIMELINE（推奨列）**
- 開始 / 終了（`HH:MM:SS.mmm`）
- 字幕テキスト
- テロップ（パターンID）
- パック（パックID）
- オブジェクト1～3 / 背景（素材IDまたは直接パス）
- 効果音オフセット / X / Y / ズーム / フェードイン / フェードアウト
- 演出列：`FX_ズーム`、`FX_集中線`、`FX_シェイク`、`FX_ビネット`、`FX_モーションブラー`など
- `FX_PARAM`列：各FXの詳細パラメータをJSONで指定（例：`{"center":"0,-200","amount":0.3}`）
- 承認（AI提案採否）/ メモ
- プルダウン設定：テロップ→テロップパターン、パック→複数オブジェクト、オブジェクト*→単一オブジェクト、FX_*→定義済みFX ID

## 3. 演出（FX）モデル化
- **ズーム**：`type=zoom`、プリセット例：`zoom_in_fast`、`zoom_out_soft`。RepeatZoom系パック適用または対象ItemのZoomキーフレーム生成。
- **集中線**：`type=speedlines`、プリセット例：`speedlines_dense`、`speedlines_soft`。PNGオーバーレイやパックを利用。
- **シェイク**：`type=shake`、プリセット例：`shake_light`、`shake_heavy`。
- **ビネット**：`type=vignette`、プリセット例：`vignette_soft`。
- **モーションブラー**：`type=motionblur`、プリセット例：`mblur_short`。
- プリセットは`fx`辞書として管理（例はJSONで定義）。

## 4. 処理フロー（台帳→YMMP）
1. 各辞書シート（テロップ、単一/複数パック、レイヤ、スキーマ）を読み込む。
2. `TIMELINE`を上から順に走査し、列の左→右順をZ順として反映。
3. テロップ列：パターンをクローンし、`Text/Frame/Length`等を上書き。
4. パック列：指定パックを複製して差分を上書き。
5. オブジェクト列：単一オブジェクトを生成し、レイヤ帯へ配置。
6. FX列：FXパックを適用。未登録の場合は単体オブジェクトや簡易キーを生成。
7. ひらがな縮小フィルタ：既存Decorationsを維持しつつ、ひらがな部分の`Scale *= 0.85`。
8. 検証レポートを作成し、`.ymmp`と共に`work/`へ出力。

## 5. 出力成果物
- `work/out.ymmp`（生成されたプロジェクト）
- `work/report.json`（検証結果）
- `work/history.jsonl`（AI提案の採否履歴）
- バックアップ：`work/out_<timestamp>.ymmp`

## 6. パック抽出・登録フロー
- 変換後の`.ymmp`から以下を抽出し、`template://packs/*.json`として保存。
  - **テロップ候補**：Textを含む近接オブジェクト群またはGroup配下。
  - **複数パック候補**：Group/Tachie/Repeat系オブジェクト群。
  - **FX候補**：集中線PNG、ズーム/シェイク等を含む群。
- 重複はハッシュIDで排除。`override_keys`の初期値は`Text, FilePath, Frame, Length, X, Y, Zoom`。
- 抽出結果を各シートに追記。

## 7. AI提案と学習サイクル
- **初期提案**：SRTテキストからテロップID・オブジェクト・FXを軽量ルールで仮埋め。
- **採否管理**：承認列が`TRUE`なら正例、編集され`FALSE`なら負例として`history.jsonl`に差分保存。
- **オンライン更新**：語彙→表情/SE/FX辞書を勝敗に応じて更新。必要に応じて機械学習モデルを導入。

## 8. バリデーションとエラーハンドリング
- 必須項目：開始/終了、任意でテロップ・パック・各オブジェクト・FX。
- ファイル存在確認：参照パスが欠損していれば警告し、その行はスキップ。
- FPS/解像度差：警告を出しつつ処理継続。
- レイヤ帯溢れ：上限でクリップし警告。
- 文字コード：字幕テキストはUTF-8。改行は`\n`。

## 9. パフォーマンス・運用要件
- 想定：30秒ショート動画を数十本生成。
- 目標：1本あたり数秒〜十数秒で生成（環境依存）。
- 生成前に自動バックアップを取得。
- 成果物は`work/`ディレクトリに集約。

## 10. CLIインターフェース（例）
1. `cli make-sheet --srt in.srt --out sheet.xlsx`：SRTからTIMELINE雛形を生成（AI仮埋め）。
2. `cli absorb --ymmp template.ymmp --xlsx sheet.xlsx`：YMMPを辞書に取り込み。
3. `cli build --sheet sheet.xlsx --out work/out.ymmp`：台帳からYMMPを生成。
4. `cli filter hira-shrink --in work/out.ymmp --scale 0.85 --out work/out_shrink.ymmp`：ひらがな縮小フィルタを適用。

## 11. FXプリセット定義例
```json
{
  "fx": {
    "zoom_in_fast":   {"type": "zoom",       "pack": "fx_zoom_in_fast"},
    "zoom_out_soft":  {"type": "zoom",       "pack": "fx_zoom_out_soft"},
    "speedlines_soft":{"type": "speedlines", "pack": "fx_speedlines_soft"},
    "shake_light":    {"type": "shake",      "pack": "fx_shake_light"},
    "vignette_soft":  {"type": "vignette",   "asset": "assets/fx/vignette_soft.png"},
    "mblur_short":    {"type": "motionblur","pack": "fx_mblur_short"}
  }
}
```

## 12. TIMELINE行→生成例
- 入力：
  - 開始=`00:00:03.000` / 終了=`00:00:05.200`
  - 字幕=`「マジ!?」`
  - テロップ=`telop_強調黄`
  - パック（空欄）
  - オブジェクト1=`立ち絵_驚き`
  - オブジェクト2=`SE_ポップ`
  - `FX_ズーム=zoom_in_fast` / `FX_集中線=speedlines_soft`
- 処理：
  1. テロップパターンをFrame/Length差し替えでクローン（レイヤ帯`80–89`）。
  2. 立ち絵・SEを各レイヤ帯へ配置（例：立ち絵`70–79`、効果音`20–29`）。
  3. FXパックを再マップ（ズーム`75–79`、集中線`55–59`など）。
  4. ひらがな縮小フィルタをマージ。
  5. `out.ymmp`を生成。

## 13. セキュリティとパスの扱い
- プロジェクトルート基準の相対パスを優先。外部ドライブはUNC/絶対パスも許容（要存在確認）。
- `template://`参照は実体JSONを`packs/`配下に保存して使用。

## 14. テスト観点
- Z順：列順→レイヤ帯→相対順が崩れないこと。
- FX：ズーム/集中線/シェイクを同時適用しても帯が干渉しないこと。
- パック差分：`override_keys`が期待通り反映されること。
- ひらがな縮小：Decorationsを上書きせず乗算マージされること。
- 欠損チェック：素材欠落・パス切れで警告が出ること。
- FPS差異：警告のみで処理継続できること。

## 15. 表情プリセットとトーン自動適用
- `TIMELINE` の「表情(3つ内包)」「表情」「他1」列では、`preset:smile` や `トーン:強調` のような指示を記入可能。
- `preset:<ID>` は `EXPRESSION_PRESETS` シートのプリセットを参照し、指定パーツだけが埋まる。複数指定時は上から順に適用される。
- `トーン:<名称>` / `tone:<name>` は手動トーンヒント。`tone:none` / `トーン:なし` で自動判定を抑止。
- トーンヒントが無い場合でも字幕テキストを解析し、`質問調` / `強調` / `余韻` 等のトーンにマッチするプリセットを自動適用。該当プリセットが無ければキャラクター共通→全体共通の順でフォールバック。
- プリセットで定義していないパーツや既に手入力されているパーツは上書きしないため、ポイントでの微調整も両立できる。
